<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <meta name="Content-Type" content="text/html; charset=utf-8" />
<title>Class: Voeis::Site</title>
<link rel="stylesheet" href="../css/style.css" type="text/css" media="screen" charset="utf-8" />
<link rel="stylesheet" href="../css/common.css" type="text/css" media="screen" charset="utf-8" />

<script type="text/javascript" charset="utf-8">
  relpath = '..';
  if (relpath != '') relpath += '/';
</script>
<script type="text/javascript" charset="utf-8" src="../js/jquery.js"></script>
<script type="text/javascript" charset="utf-8" src="../js/app.js"></script>

  </head>
  <body>
    <script type="text/javascript" charset="utf-8">
      if (window.top.frames.main) document.body.className = 'frames';
    </script>
    
    <div id="header">
      <div id="menu">
  
    <a href="../_index.html">Index (S)</a> &raquo; 
    <span class='title'>Voeis</span>
     &raquo; 
    <span class="title">Site</span>
  
  
  <div class="noframes"><span class="title">(</span><a href="." target="_top">no frames</a><span class="title">)</span></div>
</div>

      <div id="search">
  <a id="class_list_link" href="#">Class List</a>
  <a id="method_list_link" href="#">Method List</a>
  <a id ="file_list_link" href="#">File List</a>
</div>

      <div class="clear"></div>
    </div>
    
    <iframe id="search_frame"></iframe>
    
    <div id="content"><h1>Class: Voeis::Site
  
  
  
</h1>

<dl class="box">
  
    <dt class="r1">Inherits:</dt>
    <dd class="r1">
      <span class="inheritName"><span class='object_link'><a href="../Object.html" title="Object (class)">Object</a></span></span>
      
        <ul class="fullTree">
          <li><span class='object_link'><a href="../Object.html" title="Object (class)">Object</a></span></li>
          
            <li class="next">Voeis::Site</li>
          
        </ul>
        <a href="#" class="inheritanceTree">show all</a>
      
      </dd>
    
  
  
    
  
    
      <dt class="r2">Includes:</dt>
      <dd class="r2">DataMapper::Resource, <span class='object_link'><a href="../Facet/DataMapper/Resource.html" title="Facet::DataMapper::Resource (module)">Facet::DataMapper::Resource</a></span>, <span class='object_link'><a href="../Yogo/Versioned/DataMapper/Resource.html" title="Yogo::Versioned::DataMapper::Resource (module)">Yogo::Versioned::DataMapper::Resource</a></span></dd>
      
    
  
  
  
    <dt class="r1 last">Defined in:</dt>
    <dd class="r1 last">app/models/voeis/site.rb</dd>
  
</dl>
<div class="clear"></div>

<h2>Overview</h2><div class="docstring">
  <div class="discussion">
    <p>
-*- coding: utf-8 -*- Sites TODO- validate the best practices below
</p>
<p>
This is a &#8220;Monitoring Site Locations&#8221; The Sites table provides
information giving the spatial location at which data values have been
collected. The following rules and best practices should be followed when
populating this table:
</p>
<ul>
<li><p>
The SiteID field is the primary key, must be a unique integer, and cannot
be NULL.  This
</p>
</li>
</ul>
<p>
field should be implemented as an auto number/identity field.
</p>
<ul>
<li><p>
The SiteCode field must contain a text code that uniquely identifies each
site.  The values
</p>
</li>
</ul>
<p>
in this field should be unique and can be an alternate key for the table. 
SiteCodes cannot contain any characters other than A-Z (case insensitive),
0-9, period “.”, dash “-“, and underscore “_”.
</p>
<ul>
<li><p>
The LatLongDatumID must reference a valid SpatialReferenceID from the
</p>
</li>
</ul>
<p>
SpatialReferences controlled vocabulary table.  If the datum is unknown, a
default value of 0 is used.
</p>
<ul>
<li><p>
If the Elevation_m field is populated with a numeric value, a value must be
specified in
</p>
</li>
</ul>
<p>
the VerticalDatum field.  The VerticalDatum field can only be populated
using terms from the VerticalDatumCV table.  If the vertical datum is
unknown, a value of “Unknown” is used.
</p>
<ul>
<li><p>
If the LocalX and LocalY fields are populated with numeric values, a value
must be
</p>
</li>
</ul>
<p>
specified in the LocalProjectionID field.  The LocalProjectionID must
reference a valid SpatialReferenceID from the SpatialReferences controlled
vocabulary table.  If the spatial reference system of the local coordinates
is unknown, a default value of 0 is used.
</p>


  </div>
</div>
<div class="tags">
  
</div>

  
  
  
  
  
  
  
  
  

  
    <h2>
      Instance Method Summary
      <small>(<a href="#" class="summary_toggle">collapse</a>)</small>
    </h2>

    <ul class="summary">
      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#create_from_his-instance_method" title="#create_from_his (instance method)">- (Object) <strong>create_from_his</strong>(id) </a>
    

    
  </span>
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'></div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#fetch_time_zone_offset-instance_method" title="#fetch_time_zone_offset (instance method)">- (Object) <strong>fetch_time_zone_offset</strong> </a>
    

    
  </span>
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'></div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#load_from_his-instance_method" title="#load_from_his (instance method)">- (Object) <strong>load_from_his</strong> </a>
    

    
  </span>
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'></div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#store_to_his-instance_method" title="#store_to_his (instance method)">- (Object) <strong>store_to_his</strong> </a>
    

    
  </span>
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'></div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#update_site_data_catalog-instance_method" title="#update_site_data_catalog (instance method)">- (Object) <strong>update_site_data_catalog</strong> </a>
    

    
  </span>
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'></div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#update_site_data_catalog_variables-instance_method" title="#update_site_data_catalog_variables (instance method)">- (Object) <strong>update_site_data_catalog_variables</strong>(variables) </a>
    

    
  </span>
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'><p>
accepts an array of varialbes that should be associated with the site.
</p>
</div></span>
  
</li>

      
    </ul>
  


  
  
  
  
  
  
  
  <h3 class="inherited">Methods included from <span class='object_link'><a href="../Yogo/Versioned/DataMapper/Resource.html" title="Yogo::Versioned::DataMapper::Resource (module)">Yogo::Versioned::DataMapper::Resource</a></span></h3>
  <p class="inherited"><span class='object_link'><a href="../Yogo/Versioned/DataMapper/Resource.html#included-class_method" title="Yogo::Versioned::DataMapper::Resource.included (method)">included</a></span></p>

  
  
  
  
  
  
  
  <h3 class="inherited">Methods included from <span class='object_link'><a href="../Facet/DataMapper/Resource.html" title="Facet::DataMapper::Resource (module)">Facet::DataMapper::Resource</a></span></h3>
  <p class="inherited"><span class='object_link'><a href="../Facet/DataMapper/Resource.html#included-class_method" title="Facet::DataMapper::Resource.included (method)">included</a></span></p>

  

  <div id="instance_method_details" class="method_details_list">
    <h2>Instance Method Details</h2>
    
    
      <div class="method_details first">
  <p class="signature first" id="create_from_his-instance_method">
  
    - (<tt><span class='object_link'><a href="../Object.html" title="Object (class)">Object</a></span></tt>) <strong>create_from_his</strong>(id) 
  

  
</p><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'app/models/voeis/site.rb', line 87</span>

<span class='kw'>def</span> <span class='id create_from_his'>create_from_his</span><span class='lparen'>(</span><span class='id id'>id</span><span class='rparen'>)</span>
  <span class='id his_s'>his_s</span> <span class='op'>=</span> <span class='id repository'>repository</span><span class='lparen'>(</span><span class='symbol'>:his</span><span class='rparen'>)</span><span class='lbrace'>{</span> <span class='const'>His</span><span class='op'>::</span><span class='const'>Site</span><span class='period'>.</span><span class='id get'>get</span><span class='lparen'>(</span><span class='id id'>id</span><span class='rparen'>)</span> <span class='rbrace'>}</span>
  <span class='id my_site'>my_site</span> <span class='op'>=</span> <span class='const'>Voeis</span><span class='op'>::</span><span class='const'>Site</span><span class='period'>.</span><span class='id new'>new</span><span class='lparen'>(</span><span class='symbol'>:his_id</span> <span class='op'>=&gt;</span> <span class='id his_s'>his_s</span><span class='period'>.</span><span class='id id'>id</span><span class='comma'>,</span>
                     <span class='symbol'>:site_code</span> <span class='op'>=&gt;</span> <span class='id his_s'>his_s</span><span class='period'>.</span><span class='id site_code'>site_code</span><span class='comma'>,</span>
                     <span class='symbol'>:site_name</span>  <span class='op'>=&gt;</span> <span class='id his_s'>his_s</span><span class='period'>.</span><span class='id site_name'>site_name</span><span class='comma'>,</span>
                     <span class='symbol'>:latitude</span>  <span class='op'>=&gt;</span> <span class='id his_s'>his_s</span><span class='period'>.</span><span class='id latitude'>latitude</span><span class='comma'>,</span>
                     <span class='symbol'>:longitude</span>  <span class='op'>=&gt;</span> <span class='id his_s'>his_s</span><span class='period'>.</span><span class='id longitude'>longitude</span><span class='comma'>,</span>
                     <span class='symbol'>:lat_long_datum_id</span> <span class='op'>=&gt;</span> <span class='id his_s'>his_s</span><span class='period'>.</span><span class='id lat_long_datum_id'>lat_long_datum_id</span><span class='comma'>,</span>
                     <span class='symbol'>:elevation_m</span>   <span class='op'>=&gt;</span> <span class='id his_s'>his_s</span><span class='period'>.</span><span class='id elevation_m'>elevation_m</span><span class='comma'>,</span>
                     <span class='symbol'>:vertical_datum</span>  <span class='op'>=&gt;</span> <span class='id his_s'>his_s</span><span class='period'>.</span><span class='id vertical_datum'>vertical_datum</span><span class='comma'>,</span>
                     <span class='symbol'>:local_x</span>  <span class='op'>=&gt;</span> <span class='id his_s'>his_s</span><span class='period'>.</span><span class='id local_x'>local_x</span><span class='comma'>,</span>
                     <span class='symbol'>:local_y</span>  <span class='op'>=&gt;</span> <span class='id his_s'>his_s</span><span class='period'>.</span><span class='id local_y'>local_y</span><span class='comma'>,</span>
                     <span class='symbol'>:local_projection_id</span>  <span class='op'>=&gt;</span> <span class='id his_s'>his_s</span><span class='period'>.</span><span class='id local_projection_id'>local_projection_id</span><span class='comma'>,</span>
                     <span class='symbol'>:pos_accuracy_m</span>  <span class='op'>=&gt;</span> <span class='id his_s'>his_s</span><span class='period'>.</span><span class='id pos_accuracy_m'>pos_accuracy_m</span><span class='comma'>,</span>
                     <span class='symbol'>:state</span>  <span class='op'>=&gt;</span> <span class='id his_s'>his_s</span><span class='period'>.</span><span class='id state'>state</span><span class='comma'>,</span>
                     <span class='symbol'>:county</span>  <span class='op'>=&gt;</span> <span class='id his_s'>his_s</span><span class='period'>.</span><span class='id county'>county</span><span class='comma'>,</span>
                     <span class='symbol'>:comments</span>  <span class='op'>=&gt;</span> <span class='id his_s'>his_s</span><span class='period'>.</span><span class='id comments'>comments</span><span class='rparen'>)</span>
  <span class='id my_site'>my_site</span><span class='period'>.</span><span class='id save'>save</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <p class="signature " id="fetch_time_zone_offset-instance_method">
  
    - (<tt><span class='object_link'><a href="../Object.html" title="Object (class)">Object</a></span></tt>) <strong>fetch_time_zone_offset</strong> 
  

  
</p><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


71
72
73
74
75
76</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'app/models/voeis/site.rb', line 71</span>

<span class='kw'>def</span> <span class='id fetch_time_zone_offset'>fetch_time_zone_offset</span>
  <span class='id require'>require</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>geonames</span><span class='tstring_end'>&quot;</span></span>
  <span class='id zone'>zone</span> <span class='op'>=</span> <span class='const'>Geonames</span><span class='op'>::</span><span class='const'>WebService</span><span class='period'>.</span><span class='id timezone'>timezone</span> <span class='kw'>self</span><span class='period'>.</span><span class='id latitude'>latitude</span><span class='comma'>,</span> <span class='kw'>self</span><span class='period'>.</span><span class='id longitude'>longitude</span>
  <span class='kw'>self</span><span class='period'>.</span><span class='id time_zone_offset'>time_zone_offset</span> <span class='op'>=</span> <span class='id zone'>zone</span><span class='period'>.</span><span class='id gmt_offset'>gmt_offset</span>
  <span class='kw'>self</span><span class='period'>.</span><span class='id save!'>save!</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <p class="signature " id="load_from_his-instance_method">
  
    - (<tt><span class='object_link'><a href="../Object.html" title="Object (class)">Object</a></span></tt>) <strong>load_from_his</strong> 
  

  
</p><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


78
79
80
81
82
83
84
85</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'app/models/voeis/site.rb', line 78</span>

<span class='kw'>def</span> <span class='id load_from_his'>load_from_his</span>
  <span class='id his_sites'>his_sites</span> <span class='op'>=</span> <span class='id repository'>repository</span><span class='lparen'>(</span><span class='symbol'>:his</span><span class='rparen'>)</span><span class='lbrace'>{</span> <span class='const'>His</span><span class='op'>::</span><span class='const'>Site</span><span class='period'>.</span><span class='id all'>all</span> <span class='rbrace'>}</span>
  <span class='id his_sites'>his_sites</span><span class='period'>.</span><span class='id each'>each</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id his_s'>his_s</span><span class='op'>|</span>
    <span class='kw'>if</span> <span class='kw'>self</span><span class='period'>.</span><span class='id first'>first</span><span class='lparen'>(</span><span class='symbol'>:his_id</span> <span class='op'>=&gt;</span> <span class='id his_s'>his_s</span><span class='period'>.</span><span class='id id'>id</span><span class='rparen'>)</span><span class='period'>.</span><span class='id nil?'>nil?</span>
      <span class='id create_from_his'>create_from_his</span><span class='lparen'>(</span><span class='id his_s'>his_s</span><span class='period'>.</span><span class='id id'>id</span><span class='rparen'>)</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <p class="signature " id="store_to_his-instance_method">
  
    - (<tt><span class='object_link'><a href="../Object.html" title="Object (class)">Object</a></span></tt>) <strong>store_to_his</strong> 
  

  
</p><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


107
108
109
110
111
112
113
114
115
116
117
118
119
120
121</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'app/models/voeis/site.rb', line 107</span>

<span class='kw'>def</span> <span class='id store_to_his'>store_to_his</span>
  <span class='id new_his_site'>new_his_site</span> <span class='op'>=</span> <span class='const'>His</span><span class='op'>::</span><span class='const'>Site</span><span class='period'>.</span><span class='id first_or_create'>first_or_create</span><span class='lparen'>(</span><span class='symbol'>:site_code</span> <span class='op'>=&gt;</span> <span class='id site_code'>site_code</span><span class='comma'>,</span> <span class='symbol'>:site_name</span>  <span class='op'>=&gt;</span> <span class='id site_name'>site_name</span><span class='comma'>,</span>
                                            <span class='symbol'>:latitude</span>  <span class='op'>=&gt;</span> <span class='id latitude'>latitude</span><span class='comma'>,</span>  <span class='symbol'>:longitude</span>  <span class='op'>=&gt;</span> <span class='id longitude'>longitude</span><span class='comma'>,</span>
                                            <span class='symbol'>:lat_long_datum_id</span> <span class='op'>=&gt;</span> <span class='id lat_long_datum_id'>lat_long_datum_id</span><span class='comma'>,</span>
                                            <span class='symbol'>:elevation_m</span>   <span class='op'>=&gt;</span> <span class='id elevation_m'>elevation_m</span><span class='comma'>,</span>
                                            <span class='symbol'>:vertical_datum</span>  <span class='op'>=&gt;</span> <span class='id vertical_datum'>vertical_datum</span><span class='comma'>,</span>
                                            <span class='symbol'>:local_x</span>  <span class='op'>=&gt;</span> <span class='id local_x'>local_x</span><span class='comma'>,</span>    <span class='symbol'>:local_y</span>  <span class='op'>=&gt;</span> <span class='id local_y'>local_y</span><span class='comma'>,</span>
                                            <span class='symbol'>:local_projection_id</span>  <span class='op'>=&gt;</span> <span class='id local_projection_id'>local_projection_id</span><span class='comma'>,</span>
                                            <span class='symbol'>:pos_accuracy_m</span>  <span class='op'>=&gt;</span> <span class='id pos_accuracy_m'>pos_accuracy_m</span><span class='comma'>,</span>
                                            <span class='symbol'>:state</span>  <span class='op'>=&gt;</span> <span class='id state'>state</span><span class='comma'>,</span>        <span class='symbol'>:county</span>  <span class='op'>=&gt;</span> <span class='id county'>county</span><span class='comma'>,</span>
                                            <span class='symbol'>:comments</span>  <span class='op'>=&gt;</span> <span class='id comments'>comments</span><span class='rparen'>)</span>
  <span class='id his_id'>his_id</span> <span class='op'>=</span> <span class='id new_his_site'>new_his_site</span><span class='period'>.</span><span class='id id'>id</span>
  <span class='id save'>save</span>
  <span class='id new_his_site'>new_his_site</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <p class="signature " id="update_site_data_catalog-instance_method">
  
    - (<tt><span class='object_link'><a href="../Object.html" title="Object (class)">Object</a></span></tt>) <strong>update_site_data_catalog</strong> 
  

  
</p><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'app/models/voeis/site.rb', line 123</span>

<span class='kw'>def</span> <span class='id update_site_data_catalog'>update_site_data_catalog</span>
  <span class='kw'>self</span><span class='period'>.</span><span class='id variables'>variables</span><span class='period'>.</span><span class='id each'>each</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id var'>var</span><span class='op'>|</span>
    <span class='id entry'>entry</span> <span class='op'>=</span> <span class='const'>Voeis</span><span class='op'>::</span><span class='const'>SiteDataCatalog</span><span class='period'>.</span><span class='id first_or_create'>first_or_create</span><span class='lparen'>(</span><span class='symbol'>:site_id</span> <span class='op'>=&gt;</span> <span class='kw'>self</span><span class='period'>.</span><span class='id id'>id</span><span class='comma'>,</span> <span class='symbol'>:variable_id</span> <span class='op'>=&gt;</span> <span class='id var'>var</span><span class='period'>.</span><span class='id id'>id</span><span class='rparen'>)</span>
    <span class='kw'>if</span> <span class='op'>!</span><span class='id var'>var</span><span class='period'>.</span><span class='id sensor_types'>sensor_types</span><span class='period'>.</span><span class='id empty?'>empty?</span>
      <span class='id entry'>entry</span><span class='period'>.</span><span class='id record_number'>record_number</span> <span class='op'>=</span> <span class='lparen'>(</span><span class='kw'>self</span><span class='period'>.</span><span class='id sensor_values'>sensor_values</span> <span class='op'>&amp;</span> <span class='id var'>var</span><span class='period'>.</span><span class='id sensor_types'>sensor_types</span><span class='period'>.</span><span class='id first'>first</span><span class='period'>.</span><span class='id sensor_values'>sensor_values</span><span class='rparen'>)</span><span class='period'>.</span><span class='id count'>count</span>
      <span class='kw'>if</span> <span class='id entry'>entry</span><span class='period'>.</span><span class='id record_number'>record_number</span> <span class='op'>&gt;</span> <span class='int'>0</span>
        <span class='id entry'>entry</span><span class='period'>.</span><span class='id starting_timestamp'>starting_timestamp</span> <span class='op'>=</span> <span class='lparen'>(</span><span class='kw'>self</span><span class='period'>.</span><span class='id sensor_values'>sensor_values</span> <span class='op'>&amp;</span> <span class='id var'>var</span><span class='period'>.</span><span class='id sensor_types'>sensor_types</span><span class='period'>.</span><span class='id first'>first</span><span class='period'>.</span><span class='id sensor_values'>sensor_values</span><span class='rparen'>)</span><span class='period'>.</span><span class='id first'>first</span><span class='lparen'>(</span><span class='symbol'>:order</span><span class='op'>=&gt;</span><span class='lbracket'>[</span><span class='symbol'>:timestamp</span><span class='rbracket'>]</span><span class='rparen'>)</span><span class='period'>.</span><span class='id timestamp'>timestamp</span>
        <span class='id entry'>entry</span><span class='period'>.</span><span class='id ending_timestamp'>ending_timestamp</span> <span class='op'>=</span> <span class='lparen'>(</span><span class='kw'>self</span><span class='period'>.</span><span class='id sensor_values'>sensor_values</span> <span class='op'>&amp;</span> <span class='id var'>var</span><span class='period'>.</span><span class='id sensor_types'>sensor_types</span><span class='period'>.</span><span class='id first'>first</span><span class='period'>.</span><span class='id sensor_values'>sensor_values</span><span class='rparen'>)</span><span class='period'>.</span><span class='id last'>last</span><span class='lparen'>(</span><span class='symbol'>:order</span><span class='op'>=&gt;</span><span class='lbracket'>[</span><span class='symbol'>:timestamp</span><span class='rbracket'>]</span><span class='rparen'>)</span><span class='period'>.</span><span class='id timestamp'>timestamp</span>
      <span class='kw'>end</span> <span class='comment'>#end if
</span>    <span class='kw'>else</span>
      <span class='id entry'>entry</span><span class='period'>.</span><span class='id record_number'>record_number</span> <span class='op'>=</span> <span class='int'>0</span>
    <span class='kw'>end</span>
    <span class='kw'>if</span> <span class='op'>!</span><span class='id var'>var</span><span class='period'>.</span><span class='id data_values'>data_values</span><span class='period'>.</span><span class='id empty?'>empty?</span>
      <span class='kw'>if</span> <span class='op'>!</span><span class='kw'>self</span><span class='period'>.</span><span class='id data_values'>data_values</span><span class='period'>.</span><span class='id nil?'>nil?</span>
        <span class='comment'>#dvalue_count = (var.data_values &amp; self.data_values).count
</span>        <span class='id sql'>sql</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>SELECT data_value_id FROM voeis_data_value_variables WHERE variable_id = </span><span class='embexpr_beg'>#{</span><span class='id var'>var</span><span class='period'>.</span><span class='id id'>id</span><span class='rbrace'>}</span><span class='tstring_content'> INTERSECT SELECT data_value_id FROM voeis_data_value_sites WHERE site_id = </span><span class='embexpr_beg'>#{</span><span class='kw'>self</span><span class='period'>.</span><span class='id id'>id</span><span class='rbrace'>}</span><span class='tstring_end'>&quot;</span></span>
        <span class='id results'>results</span> <span class='op'>=</span> <span class='id repository'>repository</span><span class='period'>.</span><span class='id adapter'>adapter</span><span class='period'>.</span><span class='id select'>select</span><span class='lparen'>(</span><span class='id sql'>sql</span><span class='rparen'>)</span>
        <span class='id entry'>entry</span><span class='period'>.</span><span class='id record_number'>record_number</span> <span class='op'>=</span> <span class='id entry'>entry</span><span class='period'>.</span><span class='id record_number'>record_number</span> <span class='op'>+</span> <span class='id results'>results</span><span class='period'>.</span><span class='id length'>length</span>
        <span class='kw'>if</span> <span class='id results'>results</span><span class='period'>.</span><span class='id length'>length</span> <span class='op'>&gt;</span> <span class='int'>0</span>
          <span class='id sql'>sql</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>SELECT * FROM voeis_data_values WHERE id IN </span><span class='embexpr_beg'>#{</span><span class='id results'>results</span><span class='period'>.</span><span class='id to_s'>to_s</span><span class='period'>.</span><span class='id gsub'>gsub</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>[</span><span class='tstring_end'>'</span></span><span class='comma'>,</span><span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>(</span><span class='tstring_end'>'</span></span><span class='rparen'>)</span><span class='period'>.</span><span class='id gsub'>gsub</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>]</span><span class='tstring_end'>'</span></span><span class='comma'>,</span><span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>)</span><span class='tstring_end'>'</span></span><span class='rparen'>)</span><span class='rbrace'>}</span><span class='tstring_content'> ORDER BY local_date_time</span><span class='tstring_end'>&quot;</span></span>
          <span class='id dresults'>dresults</span> <span class='op'>=</span> <span class='id repository'>repository</span><span class='period'>.</span><span class='id adapter'>adapter</span><span class='period'>.</span><span class='id select'>select</span><span class='lparen'>(</span><span class='id sql'>sql</span><span class='rparen'>)</span>
          <span class='id dval_first'>dval_first</span> <span class='op'>=</span> <span class='id dresults'>dresults</span><span class='period'>.</span><span class='id first'>first</span><span class='lbracket'>[</span><span class='symbol'>:local_date_time</span><span class='rbracket'>]</span><span class='comment'>#(var.data_values &amp; self.data_values).first(:order=&gt;[:local_date_time]).local_date_time
</span>          <span class='id dval_last'>dval_last</span> <span class='op'>=</span> <span class='id dresults'>dresults</span><span class='period'>.</span><span class='id first'>first</span><span class='lbracket'>[</span><span class='symbol'>:local_date_time</span><span class='rbracket'>]</span> <span class='comment'>#(var.data_values &amp; self.data_values).last(:order=&gt;[:local_date_time]).local_date_time
</span>          <span class='kw'>if</span> <span class='id entry'>entry</span><span class='period'>.</span><span class='id starting_timestamp'>starting_timestamp</span><span class='period'>.</span><span class='id nil?'>nil?</span> <span class='op'>||</span> <span class='id dval_first'>dval_first</span> <span class='op'>&lt;</span> <span class='id entry'>entry</span><span class='period'>.</span><span class='id starting_timestamp'>starting_timestamp</span>
            <span class='id entry'>entry</span><span class='period'>.</span><span class='id starting_timestamp'>starting_timestamp</span> <span class='op'>=</span> <span class='id dval_first'>dval_first</span>
          <span class='kw'>end</span>
          <span class='kw'>if</span> <span class='id entry'>entry</span><span class='period'>.</span><span class='id ending_timestamp'>ending_timestamp</span><span class='period'>.</span><span class='id nil?'>nil?</span> <span class='op'>||</span>  <span class='id dval_last'>dval_last</span> <span class='op'>&gt;</span> <span class='id entry'>entry</span><span class='period'>.</span><span class='id ending_timestamp'>ending_timestamp</span>
            <span class='id entry'>entry</span><span class='period'>.</span><span class='id ending_timestamp'>ending_timestamp</span> <span class='op'>=</span> <span class='id dval_last'>dval_last</span>
          <span class='kw'>end</span>
        <span class='kw'>end</span>
      <span class='kw'>end</span>
    <span class='kw'>end</span>
    <span class='id entry'>entry</span><span class='period'>.</span><span class='id valid?'>valid?</span>
    <span class='id puts'>puts</span> <span class='id entry'>entry</span><span class='period'>.</span><span class='id errors'>errors</span><span class='period'>.</span><span class='id inspect'>inspect</span><span class='lparen'>(</span><span class='rparen'>)</span>
    <span class='id entry'>entry</span><span class='period'>.</span><span class='id save'>save</span>
  <span class='kw'>end</span> <span class='comment'>#end each
</span><span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <p class="signature " id="update_site_data_catalog_variables-instance_method">
  
    - (<tt><span class='object_link'><a href="../Object.html" title="Object (class)">Object</a></span></tt>) <strong>update_site_data_catalog_variables</strong>(variables) 
  

  
</p><div class="docstring">
  <div class="discussion">
    <p>
accepts an array of varialbes that should be associated with the site.
</p>


  </div>
</div>
<div class="tags">
  
</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'app/models/voeis/site.rb', line 162</span>

<span class='kw'>def</span> <span class='id update_site_data_catalog_variables'>update_site_data_catalog_variables</span><span class='lparen'>(</span><span class='id variables'>variables</span><span class='rparen'>)</span>
  <span class='id variables'>variables</span><span class='period'>.</span><span class='id each'>each</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id var'>var</span><span class='op'>|</span>
    <span class='id entry'>entry</span> <span class='op'>=</span> <span class='const'>Voeis</span><span class='op'>::</span><span class='const'>SiteDataCatalog</span><span class='period'>.</span><span class='id first_or_create'>first_or_create</span><span class='lparen'>(</span><span class='symbol'>:site_id</span> <span class='op'>=&gt;</span> <span class='kw'>self</span><span class='period'>.</span><span class='id id'>id</span><span class='comma'>,</span> <span class='symbol'>:variable_id</span> <span class='op'>=&gt;</span> <span class='id var'>var</span><span class='period'>.</span><span class='id id'>id</span><span class='rparen'>)</span>
    <span class='kw'>if</span> <span class='op'>!</span><span class='id var'>var</span><span class='period'>.</span><span class='id sensor_types'>sensor_types</span><span class='period'>.</span><span class='id empty?'>empty?</span>
      <span class='id entry'>entry</span><span class='period'>.</span><span class='id record_number'>record_number</span> <span class='op'>=</span> <span class='lparen'>(</span><span class='kw'>self</span><span class='period'>.</span><span class='id sensor_values'>sensor_values</span> <span class='op'>&amp;</span> <span class='id var'>var</span><span class='period'>.</span><span class='id sensor_types'>sensor_types</span><span class='period'>.</span><span class='id first'>first</span><span class='period'>.</span><span class='id sensor_values'>sensor_values</span><span class='rparen'>)</span><span class='period'>.</span><span class='id count'>count</span>
      <span class='kw'>if</span> <span class='id entry'>entry</span><span class='period'>.</span><span class='id record_number'>record_number</span> <span class='op'>&gt;</span> <span class='int'>0</span>
        <span class='id entry'>entry</span><span class='period'>.</span><span class='id starting_timestamp'>starting_timestamp</span> <span class='op'>=</span> <span class='lparen'>(</span><span class='kw'>self</span><span class='period'>.</span><span class='id sensor_values'>sensor_values</span> <span class='op'>&amp;</span> <span class='id var'>var</span><span class='period'>.</span><span class='id sensor_types'>sensor_types</span><span class='period'>.</span><span class='id first'>first</span><span class='period'>.</span><span class='id sensor_values'>sensor_values</span><span class='rparen'>)</span><span class='period'>.</span><span class='id first'>first</span><span class='lparen'>(</span><span class='symbol'>:order</span><span class='op'>=&gt;</span><span class='lbracket'>[</span><span class='symbol'>:timestamp</span><span class='rbracket'>]</span><span class='rparen'>)</span><span class='period'>.</span><span class='id timestamp'>timestamp</span>
        <span class='id entry'>entry</span><span class='period'>.</span><span class='id ending_timestamp'>ending_timestamp</span> <span class='op'>=</span> <span class='lparen'>(</span><span class='kw'>self</span><span class='period'>.</span><span class='id sensor_values'>sensor_values</span> <span class='op'>&amp;</span> <span class='id var'>var</span><span class='period'>.</span><span class='id sensor_types'>sensor_types</span><span class='period'>.</span><span class='id first'>first</span><span class='period'>.</span><span class='id sensor_values'>sensor_values</span><span class='rparen'>)</span><span class='period'>.</span><span class='id last'>last</span><span class='lparen'>(</span><span class='symbol'>:order</span><span class='op'>=&gt;</span><span class='lbracket'>[</span><span class='symbol'>:timestamp</span><span class='rbracket'>]</span><span class='rparen'>)</span><span class='period'>.</span><span class='id timestamp'>timestamp</span>
      <span class='kw'>end</span> <span class='comment'>#end if
</span>    <span class='kw'>else</span>
      <span class='id entry'>entry</span><span class='period'>.</span><span class='id record_number'>record_number</span> <span class='op'>=</span> <span class='int'>0</span>
    <span class='kw'>end</span>
    <span class='kw'>if</span> <span class='op'>!</span><span class='id var'>var</span><span class='period'>.</span><span class='id data_values'>data_values</span><span class='period'>.</span><span class='id empty?'>empty?</span>
      <span class='kw'>if</span> <span class='op'>!</span><span class='kw'>self</span><span class='period'>.</span><span class='id data_values'>data_values</span><span class='period'>.</span><span class='id nil?'>nil?</span>
        <span class='comment'>#dvalue_count = (var.data_values &amp; self.data_values).count
</span>        <span class='id sql'>sql</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>SELECT data_value_id FROM voeis_data_value_variables WHERE variable_id = </span><span class='embexpr_beg'>#{</span><span class='id var'>var</span><span class='period'>.</span><span class='id id'>id</span><span class='rbrace'>}</span><span class='tstring_content'> INTERSECT SELECT data_value_id FROM voeis_data_value_sites WHERE site_id = </span><span class='embexpr_beg'>#{</span><span class='kw'>self</span><span class='period'>.</span><span class='id id'>id</span><span class='rbrace'>}</span><span class='tstring_end'>&quot;</span></span>
        <span class='id results'>results</span> <span class='op'>=</span> <span class='id repository'>repository</span><span class='period'>.</span><span class='id adapter'>adapter</span><span class='period'>.</span><span class='id select'>select</span><span class='lparen'>(</span><span class='id sql'>sql</span><span class='rparen'>)</span>
        <span class='id entry'>entry</span><span class='period'>.</span><span class='id record_number'>record_number</span> <span class='op'>=</span> <span class='id entry'>entry</span><span class='period'>.</span><span class='id record_number'>record_number</span> <span class='op'>+</span> <span class='id results'>results</span><span class='period'>.</span><span class='id length'>length</span>
        <span class='kw'>if</span> <span class='id results'>results</span><span class='period'>.</span><span class='id length'>length</span> <span class='op'>&gt;</span> <span class='int'>0</span>
          <span class='id sql'>sql</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>SELECT * FROM voeis_data_values WHERE id IN </span><span class='embexpr_beg'>#{</span><span class='id results'>results</span><span class='period'>.</span><span class='id to_s'>to_s</span><span class='period'>.</span><span class='id gsub'>gsub</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>[</span><span class='tstring_end'>'</span></span><span class='comma'>,</span><span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>(</span><span class='tstring_end'>'</span></span><span class='rparen'>)</span><span class='period'>.</span><span class='id gsub'>gsub</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>]</span><span class='tstring_end'>'</span></span><span class='comma'>,</span><span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>)</span><span class='tstring_end'>'</span></span><span class='rparen'>)</span><span class='rbrace'>}</span><span class='tstring_content'> ORDER BY local_date_time</span><span class='tstring_end'>&quot;</span></span>
          <span class='id dresults'>dresults</span> <span class='op'>=</span> <span class='id repository'>repository</span><span class='period'>.</span><span class='id adapter'>adapter</span><span class='period'>.</span><span class='id select'>select</span><span class='lparen'>(</span><span class='id sql'>sql</span><span class='rparen'>)</span>
          <span class='id dval_first'>dval_first</span> <span class='op'>=</span> <span class='id dresults'>dresults</span><span class='period'>.</span><span class='id first'>first</span><span class='lbracket'>[</span><span class='symbol'>:local_date_time</span><span class='rbracket'>]</span><span class='comment'>#(var.data_values &amp; self.data_values).first(:order=&gt;[:local_date_time]).local_date_time
</span>          <span class='id dval_last'>dval_last</span> <span class='op'>=</span> <span class='id dresults'>dresults</span><span class='period'>.</span><span class='id first'>first</span><span class='lbracket'>[</span><span class='symbol'>:local_date_time</span><span class='rbracket'>]</span> <span class='comment'>#(var.data_values &amp; self.data_values).last(:order=&gt;[:local_date_time]).local_date_time
</span>          <span class='kw'>if</span> <span class='id entry'>entry</span><span class='period'>.</span><span class='id starting_timestamp'>starting_timestamp</span><span class='period'>.</span><span class='id nil?'>nil?</span> <span class='op'>||</span> <span class='id dval_first'>dval_first</span> <span class='op'>&lt;</span> <span class='id entry'>entry</span><span class='period'>.</span><span class='id starting_timestamp'>starting_timestamp</span>
            <span class='id entry'>entry</span><span class='period'>.</span><span class='id starting_timestamp'>starting_timestamp</span> <span class='op'>=</span> <span class='id dval_first'>dval_first</span>
          <span class='kw'>end</span>
          <span class='kw'>if</span> <span class='id entry'>entry</span><span class='period'>.</span><span class='id ending_timestamp'>ending_timestamp</span><span class='period'>.</span><span class='id nil?'>nil?</span> <span class='op'>||</span>  <span class='id dval_last'>dval_last</span> <span class='op'>&gt;</span> <span class='id entry'>entry</span><span class='period'>.</span><span class='id ending_timestamp'>ending_timestamp</span>
            <span class='id entry'>entry</span><span class='period'>.</span><span class='id ending_timestamp'>ending_timestamp</span> <span class='op'>=</span> <span class='id dval_last'>dval_last</span>
          <span class='kw'>end</span>
        <span class='kw'>end</span>
      <span class='kw'>end</span>
    <span class='kw'>end</span>
    <span class='id entry'>entry</span><span class='period'>.</span><span class='id valid?'>valid?</span>
    <span class='id puts'>puts</span> <span class='id entry'>entry</span><span class='period'>.</span><span class='id errors'>errors</span><span class='period'>.</span><span class='id inspect'>inspect</span><span class='lparen'>(</span><span class='rparen'>)</span>
    <span class='id entry'>entry</span><span class='period'>.</span><span class='id save'>save</span>
  <span class='kw'>end</span> <span class='comment'>#end each
</span><span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
  </div>

</div>
    
    <div id="footer">
  Generated on Tue Jul 26 13:52:46 2011 by 
  <a href="http://yardoc.org" title="Yay! A Ruby Documentation Tool" target="_parent">yard</a>
  0.6.3 (ruby-1.9.2).
</div>

  </body>
</html>