<%# I started to move this into a helper, but I think it's okay here for now. %>
<%- if @model.name.blank? -%>
  <%- path = project_yogo_models_path(@project) -%>
  <%- method = :post -%>
<%- else -%>
  <%- path = project_yogo_model_path(@project, @model.name.demodulize) -%>
  <%- method = :put -%>
<%- end -%>

<%- options = options_for_select(@options) -%> 
<%- current_pos = 0 -%>
       
<div id="model-edit">
  <%- form_for(@model, :url => path, :html => { :method => method }) do |f| -%>
  
    <%# Output errors if there are any. %>
    <%- if flash[:model_errors] -%>
      <%- flash[:model_errors].each_pair do |key,value| -%>
        <%= h key + value %>
      <%- end -%>
    <%- end -%>
  
    <%# If this is a new model, ask for its name. %>
    <%- if @model.name.blank? -%>
      <div>Model Name:</div>
      <div><%= text_field_tag(:class_name) %></div>
      
      <ul id='sortable'>
    <%- else -%>
      <h3><%= @model.name %></h3>
      <ul id='sortable'>
        <%- @model.usable_properties.each do |prop| %>
          <li >
            <span class='grippie'>:::</div>
            <div ><%= h prop.display_name.to_s.titleize %> :</div>
            <div>                
              <%= select_tag( "property_#{prop.name}_type", 
                    options_for_select( @options, 
                                        Yogo::Types.dm_to_human(prop.type)), 
                                        :name => "property[#{prop.name}][type]") %>
              <%= hidden_field_tag( "property_#{prop.name}_position", 
                                    current_pos += 1, 
                                    :name => "property[#{prop.name}][position]" ) %>
            </div>
          </li>
        <%- end %>
      <%- end -%>
    
       <li class='new-property' >
          <span class='grippie'>:::</div>
          <div><%= label_tag(:name, 'Property Name') %>:</div> 
          <div>
            <%= text_field_tag(:name, nil, :name => 'new_property[][name]') %>
            <%- options = options_for_select(@options) -%> 
            <%= label_tag(:type) %>:
            <%= select_tag(:type, options, :name => 'new_property[][type]' ) %>
            <%= hidden_field_tag( "position", 
                                  current_pos += 1, :name => "new_property[][position]" ) %>
            <%= link_to(image_tag('remove.png')+'Remove', '', :class => 'remove-new-property') %>
          </div>
      </li>
    </ul>
    <br />
    <%= link_to(image_tag('add.gif')+' Add a property', '', :id => 'add-property') %>
  <br /><br />
  <div class='form-element'>
    <div class='box' >&nbsp;</div>
    <%= f.submit('Save') %>
    <%= link_to('Cancel', project_path(@project), :class => 'cancel') %>
  </div>
    
  <%- end -%>
</div>

<div style="display:none" id='form-template'>  
  <div>
    <span class='grippie'>:::</div>
    <%= label_tag(:name, 'Property Name') %>:
  </div> 
  <div>
    <%= text_field_tag(:name, nil, :name => 'new_property[][name]') %>
    <%- options = options_for_select(@options) -%> 
    <%= label_tag(:type) %>:
    <%= select_tag(:type, options, :name => 'new_property[][type]' ) %>
    <%= hidden_field_tag("position", current_pos +=1, :name => "new_property[][position]" ) %>
    <%= link_to(image_tag('remove.png')+'Remove', '', :class => 'remove-new-property') %>
  </div>
  
</div>
