- content_for(:javascripts) do
  :javascript
    dojo.require("dijit.dijit");
    dojo.require("dijit.Dialog");
    dojo.require("dijit.form.Form");
    dojo.require("dijit.form.Button");
    dojo.require("dojox.form.Uploader");
    dojo.require("dojox.grid.EnhancedGrid");
    dojo.require("dojox.grid.enhanced.plugins.NestedSorting");
    dojo.require("dojox.grid.enhanced.plugins.Filter");
    dojo.require("dojo.data.ItemFileReadStore");
    dojo.require("dijit.layout.TabContainer");
    dojo.require("dojo.data.ItemFileReadStore");
    dojo.require("voeis.Server");
    variableDataStore = voeis.Server.DEFAULT.globalVariablesDataStore();
    var site_data = [
       #{@sites.map{|site| "        "+site.to_json}.join(",\n")}
     ];
     var psites_json = {
         identifier: 'id',
         label: 'name',
         items: site_data };

%h2
  = link_to(@project.name, project_path(@project) , :onload=> "$('#loader').toggle();")

%h3 Field Data Measurement Input Form

= form_tag("create_field_measurement", :url => "create",:onSubmit => "return checkform();") do 
  Data Measurement Value: 
  =text_field_tag ("sensor_value")
  =clear_break
  %h4{:style=>'margin-top:10px;'} Select A Site:
  #site_store{:dojoType=>"dojo.data.ItemFileReadStore", :jsId=>"psites", :data=>"psites_json"}
  %table{:dojoType=>"dojox.grid.EnhancedGrid", :plugins=> "{filter:true}",  :store=>"psites", :clientSort=>"true", :style=>"width: 650px; height: 250px;", :rowSelector=>"20px", :jsId=>"SiteDisplayGrid", :id=>"SiteDisplayGrid", :title=>"Sites"}
   
    %thead
      %tr
        %th{:field=>"name", :width=>"190px", :filterable=>true} Name
        %th{:field=>"code", :width=>"130px", :filterable=>true} Code
        %th{:field=>"latitude", :width=>"100px", :filterable=>true} Lat
        %th{:field=>"longitude", :width=>"100px", :filterable=>true} Long
    %script{:type=>"dojo/method", :event=>"onClick", :args=>"evt"}
      var item = SiteDisplayGrid.selection.getSelected();
      if (item.length < 1){
      //do nothing
      }
      else{
      $("#site_id").val(item[0]["id"]);
      $("#site_span").text(""+item[0]["name"]);
      }
  = hidden_field_tag(:site_id)
  Site To Associate With Data And Sample:
  %span{:id=>"site_span"}None
  =clear_break
  -@variable_options=""
  Select what VOEIS variable this is:
  %div{:dojoType=>"dojo.data.ItemFileReadStore", :jsId=>"variableStore", :url=>"#{root_url+"projects/"+@project.id+"/apivs/dojo_variables_for_tree.json?"}"}
  %table{:dojoType=>"dojox.grid.EnhancedGrid", :plugins=> "{nestedSorting:true, filter:true}",  :store=>"variableDataStore", :clientSort=>"true", :style=>"width: 800px; height: 300px;", :rowSelector=>"20px", :jsId=>"Variablegrid", :id=>"Variablegrid"}
    %thead
      %tr
        -@var_properties.each do |prop|
          %th{:field=>"#{prop.to_s}", :width=>"100px", :filterable=>true}
            #{prop.to_s.capitalize!.gsub("_", " ")}
  
  -@variables.all(:order => [:variable_name.asc]).each do |var|
    -if var.id != nil
      -unit_abbreviation = @units.first(:id => var.variable_units_id).nil? ? "NA" : @units.first(:id => var.variable_units_id).units_abbreviation.to_s 
      -@variable_options= @variable_options + "<option value="+var.id.to_s+">"+var.variable_name+":"+var.variable_code+":"+var.sample_medium+":"+var.data_type+":"+unit_abbreviation.to_s+"</option>"
  =select_tag("variable", @variable_options.html_safe)
  =clear_break
  Select a Timestamp for this Measurement:
  =datetime_select("time", "stamp", :default => DateTime.now, :start_year => 1900)
  =clear_break
  Select the Time Zone this Measurement was collected in:
  = time_zone_select("time", "zone", nil, :default => "Mountain Time (US & Canada)")
  =clear_break
  Enter the vertical offset for the Measurement:
  =text_field_tag("vertical_offset", 0.0)
  =clear_break
  =clear_break
  =submit_tag("Submit", :onclick => "$('#loader').toggle();")
  = link_to('Cancel', {:action => 'show', :controller => '/projects', :id=>@project.id }, :class => 'icon icon-cancel', :onclick => "$('#loader').toggle();", :onload => "$('#loader').toggle();")

:javascript  
  function checkform()
  {if ($('#vertical_offset').val() =="")
  {
  // something is wrong
  alert('The Vertical Offset field requires a value before this form can be submitted.');
  $('#loader').toggle();
  return false;
  }
  // If the script gets this far through all of your fields
  // without problems, it's ok and you can submit the form
  return true;
  }
